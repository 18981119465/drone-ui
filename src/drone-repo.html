
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/page-title/page-title.html">

<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="drone-api.html">
<link rel="import" href="drone-badges.html">
<link rel="import" href="drone-build.html">
<link rel="import" href="drone-build-list.html">
<link rel="import" href="drone-error.html">
<link rel="import" href="drone-feed.html">
<link rel="import" href="drone-logo.html">
<link rel="import" href="drone-repo-settings.html">
<link rel="import" href="drone-toolbar.html">

<dom-module id="drone-repo">
	<template>
		<style>
			:host iron-selector {
				display:block;
				margin: 0px;
				padding: 0px 40px;
				margin-bottom: 40px;
				border-bottom: 1px solid #EEE;
				min-height: 49px;
				max-height: 49px;
				height: 49px;
			}

			:host iron-selector a {
				display: inline-block;
				line-height:49px;
				padding-right:20px;
				text-decoration: none;
				color: #9E9E9E;
				color: #212121;
				font-size:15px;
			}

			:host iron-selector a:hover,
			:host iron-selector a.iron-selected {
				color: #212121;
				color: #00BFA5;
			}

			:host iron-pages {
				padding: 30px 40px;
				padding-top:0px;
				position:relative;
			}

			:host .alert {
				text-align: center;
				border-top: 1px solid #EEE;
				padding-top: 150px;
				color: #9E9E9E;
				font-size:15px;
			}

			:host .alert a {
				color: #212121;
			}

			:host [name="welcome"] {
				background: #EEE;
				margin-top: 30px;
				padding: 30px;
				border-radius: 2px;
			}

			paper-progress {
				width: 100%;
				position: absolute;
				top: 0px;
				right: 0px;
				left: 0px;

				--paper-progress-active-color: #00BFA5
				--paper-progress-container-color: #EEEEEE;
			}
		</style>

		<app-route
			id="repoRoute"
			route="[[route]]"
			pattern="/:page"
			data={{data}}
			tail={{tail}}>
		</app-route>

		<drone-api id="drone"></drone-api>

		<iron-signals
			on-iron-signal-event="handleEvent">
		</iron-signals>

		<template is="dom-if" if="[[active]]">
			<page-title
				title="drone"
				base-title="[[name]]">
			</page-title>
		</template>

		<drone-shell>
			<div drone-aside>
				<!-- if authenticated, show repository list -->
				<template is="dom-if" if="[[user]]">
					<drone-feed repos={{repos}}></drone-feed>
				</template>

				<!-- if not authenticated, show login link -->
				<template is="dom-if" if="[[!user]]">
					<div class="alert">
						<a href="/login" target="_self">Login</a> to view
						your repository list.
					</div>
				</template>
			</div>

			<div drone-header>
				<drone-toolbar page="[[repo.full_name]]" user="[[user]]"></drone-toolbar>
			</div>

			<div drone-main>
				<template is="dom-if" if="[[error]]">
					<drone-error error="[[error]]"></drone-error>
				</template>

				<template is="dom-if" if="[[repo]]">
					<iron-selector
						selected="[[resolvePage(data, route)]]"
						attr-for-selected="name"
						role="navigation">

							<a name="builds" href="/[[owner]]/[[name]]">History</a>
							<a name="badges" href="/[[owner]]/[[name]]/badges">Badges</a>
							<a name="settings" href="/[[owner]]/[[name]]/settings">Settings</a>
					</iron-selector>
				</template>

				<iron-pages
					role="main"
					selected="[[resolvePage(data, route)]]"
					attr-for-selected="name"
					selected-attribute="active">

					<drone-repo-settings
						name="settings"
						repo={{repo}}
						user="[[user]]">
					</drone-repo-settings>

					<drone-badges
						name="badges"
						repo=[[repo]]>
					</drone-badges>

					<drone-build
						name="build"
						repo=[[repo]]
						route=[[route]]>
					</drone-build>

					<drone-build-list
						name="builds"
						repo=[[repo]]
						route=[[route]]>
					</drone-build-list>

					<div name="welcome">
						<div>Welcome to Drone</div>
					</div>
				</iron-pages>
			</div>
		</drone-shell>
	</template>

	<script>
		Polymer({
			is: "drone-repo",
			properties: {
				active: {
					type: Boolean,
					value: false
				},
				route: Object,
				owner: String,
				name: String,
				user: Object
			},
			observers: [
				"refreshThrottled(route, owner, name, active)"
			],
			attached: function() {
				this.$.drone.getBuildFeed({latest:true}).then(function(repos) {
					this.set("repos", repos);
				}.bind(this));
			},
			handleEvent(e) {
				this.update(e.detail, this.repos);
			},
			update: function(event, repos) {
				for (var i=0; i<repos.length; i++) {
					var repo = repos[i];
					if (repo.full_name != event.repo.full_name) {
						continue;
					}
					this.set("repos."+i+".number", event.build.number);
					this.set("repos."+i+".started_at", event.build.started_at);
					this.set("repos."+i+".finished_at", event.build.finished_at);
					this.set("repos."+i+".status", event.build.status);

					// HACK: this seems to be the only way to force the dom-repeat
					// to refresh the ordering.
					this.set("repos", this.repos.slice(0));
					break;
				}
			},
			refresh: function(route, owner, name, active) {
				if (this.repo
					&& this.repo.owner == owner
					&& this.repo.name == name) return;

				this.$.drone.getRepo(owner, name).then(function(repo) {
					this.set("error", null);
					this.set("repo", repo);
				}.bind(this)).catch(function(error) {
					this.set("error", error);
				}.bind(this));
			},
			refreshThrottled: function(route, owner, name, active) {
				if (!active) return;
				// HACK this debounce is required because each of the above parameters
				// trigger a refresh. This means a single route change will cause
				// this to execute 4x each with a different parameter permutation.
				this.debounce("repo", function () {
					this.refresh(route, owner, name, active);
				}.bind(this), 20);
			},
			resolvePage: function(params, route) {
				if (!this.name) {
					return "welcome";
				}
				if (!this.$.repoRoute.active) {
					return "builds";
				}
				switch (params.page) {
				case "settings":
					return "settings";
				case "badges":
					return "badges";
				default:
					return "build";
				}
			}
		});
	</script>
</dom-module>
